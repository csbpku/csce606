= render :partial => 'banner'

#map

  :javascript
    var apiKey = 'AIzaSyAOoWZdZFz8nFtVjBlWRysnSoSoSguqCII';
    var map;
    var snappedCoordinates = [];
    function initMap() {
        var tamuCenter = {lat: 30.6187199, lng: -96.3364829};
    
        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 15,
            center: tamuCenter,
    	      mapTypeControlOptions: {
                style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
                position: google.maps.ControlPosition.TOP_RIGHT
            }
          });
       }
       
    //var qd = {};
    //location.search.substr(1).split("&").forEach(
            //function(item) {var s = item.split("="), k = s[0], v = s[1] && decodeURIComponent(s[1]); (qd[k] = qd[k] || []).push(v)})
    function display() 
    {
        initMap();
        $.ajax({url: 'display_route',
               dataType: 'json',
               timeout: 5000,
               success: function(data) { draw_route(data); }
               });
        // the new front end function:
        // runGNavigation(qd['path%5B%5D']);
        // runSnapToRoad(qd['path%5B%5D']);

    }
    
    function draw_route(data) 
    {
      var i;
      for(i = 0; i < data.length; i++) 
      { 
        path = data[i];
        switch(path.transportation_type) {
          case "walk":
            runGNavigation(path.nav_points);
            break;
          case "bus":
            runSnapToRoad(path.nav_points.map(toString))
            add_markers(path.nav_points, path.bus_route_name);
        }
      }
    }
    
    function toString(latlon) 
    { 
      result = "" + latlon.lat + ", " + latlon.lng;
      return result;
    }
    
    function runGNavigation(data)
    {
      start = data[0];
      end = data[1];
      
      startToEnd = {
        origin:  start,
        destination: end,
        travelMode: 'WALKING'
      };
      
      var directionsService = new google.maps.DirectionsService;
      var directionStartToEnd = new google.maps.DirectionsRenderer({
        map: map,
        polylineOptions : {
          strokeColor:'green',
          strokeOpacity: 0.7,
        },
        //suppressMarkers: true
      });
      
      directionsService.route(startToEnd, function(response, status) {
        if (status === 'OK') {
          directionStartToEnd.setDirections(response);
          var route = response.routes[0];
        } else {
          window.alert('Directions request failed due to ' + status);
        }
      });
    }

    function runSnapToRoad(path) {  
      $.get('https://roads.googleapis.com/v1/snapToRoads', {
        interpolate: true,
        key: apiKey,
        path: path.join('|')
      }, function(data) {
        processSnapToRoadResponse(data);
        drawSnappedPolyline();
      });
    }
    
    // Store snapped polyline returned by the snap-to-road service.
    function processSnapToRoadResponse(data) {
      snappedCoordinates = [];
      placeIdArray = [];
      for (var i = 0; i < data.snappedPoints.length; i++) {
        var latlng = new google.maps.LatLng(
            data.snappedPoints[i].location.latitude,
            data.snappedPoints[i].location.longitude);
        snappedCoordinates.push(latlng);
        //placeIdArray.push(data.snappedPoints[i].placeId);
      }
    }
    
    // Draws the snapped polyline (after processing snap-to-road response).
    function drawSnappedPolyline() {
      var snappedPolyline = new google.maps.Polyline({
        path: snappedCoordinates,
        strokeColor: 'red',
        strokeWeight: 3
      });
    
      snappedPolyline.setMap(map);
      //polylines.push(snappedPolyline);
    }
    
    function add_markers(points, route_name) {       
        var infowindow = new google.maps.InfoWindow({
            content: "Bus route:" + route_name
         });
        var marker = new google.maps.Marker({
            position: points[1],
            map: map,
            title: route_name
        });
        
        marker.addListener('click', function() {
            infowindow.open(map, marker);
        });
    }
  %script{:async => "", :defer => "defer", :src => "https://maps.googleapis.com/maps/api/js?key=AIzaSyBGXhzWszzxqmajf5w0AzEmFi5hbgA8VRY&callback=display"}
  :cdata
